# Declarative Schema Workflow

Based on [Supabase Declarative Database Schemas](https://supabase.com/docs/guides/local-development/declarative-database-schemas).

---

## ⚠️ db diff requires Docker

The official guide uses `supabase db diff` to auto-generate migrations. That command needs Docker (shadow database). Without Docker, use manual migrations: create migration files by hand and push. See [Workflow without Docker](#workflow-without-docker) below.

---

## Structure

```
supabase/
├── config.toml          # schema_paths point to schema files
├── schemas/
│   ├── 01_uploads.sql       # Parent table (run first)
│   └── 02_task_suggestions.sql   # Child table (FK to uploads)
└── migrations/          # Generated by db diff
```

---

## Workflow

### 1. Edit schema

Edit files in `supabase/schemas/` to reflect the **desired state**. Tables, columns, indexes — define what you want, not how to get there.

- **Order matters:** Parent tables before children. Use filename prefixes (`01_`, `02_`, `03_`) so lexicographic order is correct.
- **Add new tables ad hoc:** Create `03_new_table.sql` (or similar) — the glob in config picks it up automatically.
- **Append columns:** When adding columns to existing tables, append to the end to avoid noisy diffs.

### 2. Generate migration

```bash
npx supabase db diff -f descriptive_migration_name
```

This compares your declared schema against the current database and writes a new migration to `supabase/migrations/`.

**Remote-only (no local Docker):**
```bash
npx supabase db diff --linked -f descriptive_migration_name
```

### 3. Review the migration

Open the generated file in `supabase/migrations/`. Confirm it only contains the intended changes.

### 4. Apply to remote

**⚠️ Follow the database-migrations rule: assess risk, get confirmation.**

```bash
npx supabase db push --linked
```

### 5. Commit

Commit both the schema files and the new migration.

---

## Workflow without Docker

When `db diff` is unavailable (no Docker):

1. **Edit schema** — Same as above: edit `supabase/schemas/*.sql`.
2. **Create migration manually:**
   ```bash
   npx supabase migration new descriptive_name
   ```
   Copy the SQL from your schema changes into the new migration file (or write the ALTER TABLE / CREATE TABLE etc. by hand).
3. **Apply and commit** — Same as above: `db push --linked`, then commit.

Ref: [supabase migration new](https://supabase.com/docs/reference/cli/supabase-migration-new)

---

## PostgreSQL practices used

- **uuid** with `gen_random_uuid()` for IDs
- **timestamptz** for `created_at` (timezone-aware)
- **text** for variable-length strings (filename, session_id, etc.)
- **date** for `due_date` (no time)
- **NOT NULL** where required
- **REFERENCES ... ON DELETE CASCADE** for task_suggestions → uploads
- **Indexes** on `session_id` and `upload_id` for lookups
